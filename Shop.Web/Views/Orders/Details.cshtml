@using Shop.Web.ViewModels.Orders
@using Shop.Contracts.Orders
@model OrderDetailsViewModel

@{
    ViewData["Title"] = "Detalle de la orden";
}

@section Scripts {
    <link rel="stylesheet" href="~/css/order-details.css" asp-append-version="true" />
}

<div class="od-wrap a-fadeUp">
    <div class="od-inner">

        <div class="od-head">
            <div>
                <h1 class="od-title">Detalle de la orden</h1>

                <div class="od-meta">
                    <span><b>Id:</b> @Model.Order.Id.ToString()</span>
                    <span><b>Fecha:</b> @Model.Order.CreatedAt.ToLocalTime()</span>
                </div>
            </div>

            <div style="text-align:right">
                <p class="od-total">@Model.Order.TotalAmount.ToString("C")</p>

                @if (Model.Order.Status == OrderStatus.Pending)
                {
                    <span class="od-status pending">⏳ Pending</span>
                }
                else if (Model.Order.Status == OrderStatus.Paid)
                {
                    <span class="od-status paid">✅ Paid</span>
                }
                else
                {
                    <span class="od-status">@Model.Order.Status</span>
                }
            </div>
        </div>

        <div class="od-actions">
            @if (Model.Order.Status == OrderStatus.Pending)
            {
                <a class="btn btn-success"
                   asp-controller="Payments"
                   asp-action="Checkout"
                   asp-route-orderId="@Model.Order.Id">
                    Pagar esta orden
                </a>
            }
            else if (Model.Order.Status == OrderStatus.Paid)
            {
                <span class="badge bg-success">Orden pagada</span>
            }

            <a asp-action="Index" class="btn btn-outline-dark">
                Volver a mis órdenes
            </a>
        </div>

        <div class="od-divider"></div>

        <h4 class="mb-2">Productos</h4>

        <div class="od-items">
            @foreach (var item in Model.Order.Items)
            {
                Model.ProductThumbnails.TryGetValue(item.ProductId, out var thumbUrl);
                var img = !string.IsNullOrWhiteSpace(thumbUrl)
                ? thumbUrl
                : Url.Content("~/images/product-placeholder.jpg");

                <div class="od-item hover-lift">
                    <div class="od-item__inner">
                        <img class="od-thumb"
                             src="@img"
                             alt="@item.ProductTitle"
                             onerror="this.onerror=null; this.src='@Url.Content("~/images/product-placeholder.jpg")';" />

                        <div class="od-item-meta">
                            <p class="od-item-title">@item.ProductTitle</p>
                            <p class="od-item-sub">
                                <span>Unitario: <b>@item.UnitPrice.ToString("C")</b></span>
                                <span>Cantidad: <b>@item.Quantity</b></span>
                            </p>
                        </div>

                        <div class="od-item-right">
                            <p class="od-item-price">@((item.UnitPrice * item.Quantity).ToString("C"))</p>
                            <p class="od-item-qty">Subtotal</p>
                        </div>
                    </div>
                </div>
            }
        </div>

    </div>
</div>
